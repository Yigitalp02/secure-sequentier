@{
    ViewData["Title"] = "Hash Calculator";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <i class="bi bi-hash display-4 text-info"></i>
                <h2 class="mt-2">Hash Calculator</h2>
                <p class="text-muted">
                    Drop a file and instantly get its SHA-256, SHA-512, and MD5 hashes.
                    <br /><strong>Your file never leaves your browser</strong> â€” all hashing is done locally.
                </p>
            </div>

            <div class="card shadow-sm rounded-4">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select File</label>
                        <div class="drop-zone" id="hashDropZone">
                            <div class="drop-icon"><i class="bi bi-file-earmark-binary"></i></div>
                            <p class="mb-1 fw-semibold">Drag &amp; drop file here</p>
                            <p class="text-muted small mb-0">or click to browse</p>
                            <input type="file" class="d-none" id="hashFileInput" />
                            <div id="hashFileName" class="mt-2" style="display:none;"></div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-info w-100 btn-lg text-white" id="hashBtn">
                        <i class="bi bi-calculator me-1"></i> Calculate Hashes
                    </button>

                    <div id="hashError" class="alert alert-warning mt-3" style="display:none;"></div>
                    <div id="hashSpinner" class="text-center mt-3" style="display:none;">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="mt-2 text-muted">Hashing file locally...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4" id="hashResults"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    (function() {
        var dropZone = document.getElementById('hashDropZone');
        var fileInput = document.getElementById('hashFileInput');
        var fileNameEl = document.getElementById('hashFileName');
        var hashBtn = document.getElementById('hashBtn');
        var errorEl = document.getElementById('hashError');
        var spinnerEl = document.getElementById('hashSpinner');
        var resultsEl = document.getElementById('hashResults');
        var selectedFile = null;

        // Drop zone
        dropZone.addEventListener('click', function() { fileInput.click(); });
        ['dragenter','dragover'].forEach(function(evt) {
            dropZone.addEventListener(evt, function(e) { e.preventDefault(); dropZone.classList.add('drag-over'); });
        });
        ['dragleave','drop'].forEach(function(evt) {
            dropZone.addEventListener(evt, function(e) { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        });
        dropZone.addEventListener('drop', function(e) {
            selectedFile = e.dataTransfer.files[0];
            showFile(selectedFile);
        });
        fileInput.addEventListener('change', function() {
            selectedFile = fileInput.files[0];
            showFile(selectedFile);
        });

        function showFile(f) {
            if (f) {
                fileNameEl.style.display = 'block';
                fileNameEl.textContent = f.name + ' (' + formatBytes(f.size) + ')';
                fileNameEl.className = 'mt-2 badge bg-info';
            }
        }

        function formatBytes(b) {
            if (b < 1024) return b + ' B';
            if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
            return (b/(1024*1024)).toFixed(1) + ' MB';
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(function() {
                var orig = btn.innerHTML;
                btn.textContent = 'Copied!';
                btn.classList.replace('btn-outline-secondary', 'btn-success');
                setTimeout(function() {
                    btn.innerHTML = orig;
                    btn.classList.replace('btn-success', 'btn-outline-secondary');
                }, 1500);
            }).catch(function() {
                // Fallback for HTTP (clipboard API may also need HTTPS)
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                var orig = btn.innerHTML;
                btn.textContent = 'Copied!';
                btn.classList.replace('btn-outline-secondary', 'btn-success');
                setTimeout(function() {
                    btn.innerHTML = orig;
                    btn.classList.replace('btn-success', 'btn-outline-secondary');
                }, 1500);
            });
        }

        hashBtn.addEventListener('click', function() {
            errorEl.style.display = 'none';
            resultsEl.innerHTML = '';

            if (!selectedFile) {
                errorEl.textContent = 'Please select a file.';
                errorEl.style.display = 'block';
                return;
            }

            spinnerEl.style.display = 'block';
            hashBtn.disabled = true;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var wordArray = CryptoJS.lib.WordArray.create(new Uint8Array(e.target.result));
                    var sha256 = CryptoJS.SHA256(wordArray).toString();
                    var sha512 = CryptoJS.SHA512(wordArray).toString();
                    var md5 = CryptoJS.MD5(wordArray).toString();

                    spinnerEl.style.display = 'none';
                    hashBtn.disabled = false;

                    // File info
                    var infoCard = document.createElement('div');
                    infoCard.className = 'card shadow-sm rounded-4 mb-3';
                    infoCard.innerHTML =
                        '<div class="card-body text-center">' +
                        '<i class="bi bi-file-earmark-check text-info" style="font-size: 2rem;"></i>' +
                        '<h5 class="mt-2">' + selectedFile.name + '</h5>' +
                        '<span class="badge bg-secondary me-1">' + formatBytes(selectedFile.size) + '</span>' +
                        '<span class="badge bg-secondary">' + new Date().toLocaleString() + '</span>' +
                        '</div>';
                    resultsEl.appendChild(infoCard);

                    // Hash cards
                    var hashes = [
                        { label: 'SHA-256', value: sha256, color: 'primary' },
                        { label: 'SHA-512', value: sha512, color: 'success' },
                        { label: 'MD5', value: md5, color: 'warning' }
                    ];

                    hashes.forEach(function(h) {
                        var card = document.createElement('div');
                        card.className = 'card mb-3 shadow-sm rounded-3';

                        var body = document.createElement('div');
                        body.className = 'card-body';

                        var header = document.createElement('div');
                        header.className = 'd-flex justify-content-between align-items-center mb-2';

                        var lbl = document.createElement('h6');
                        lbl.className = 'mb-0';
                        var badge = document.createElement('span');
                        badge.className = 'badge bg-' + h.color + ' me-2';
                        badge.textContent = h.label;
                        lbl.appendChild(badge);

                        var copyBtn = document.createElement('button');
                        copyBtn.className = 'btn btn-outline-secondary btn-sm';
                        copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Copy';
                        copyBtn.addEventListener('click', (function(val) {
                            return function() { copyToClipboard(val, this); };
                        })(h.value));

                        header.appendChild(lbl);
                        header.appendChild(copyBtn);

                        var hashDiv = document.createElement('div');
                        hashDiv.className = 'hash-display bg-body-secondary';
                        hashDiv.textContent = h.value;

                        body.appendChild(header);
                        body.appendChild(hashDiv);
                        card.appendChild(body);
                        resultsEl.appendChild(card);
                    });
                } catch(ex) {
                    spinnerEl.style.display = 'none';
                    hashBtn.disabled = false;
                    errorEl.textContent = 'Error hashing file: ' + ex.message;
                    errorEl.style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        });
    })();
    </script>
}
