@{
    Layout = "_Layout";
    var runId = ViewBag.RunId as string;
    var displayName = ViewBag.DisplayName as string ?? "Your";
}

@section Styles {
    <style>
        .file-card { margin-bottom: 1rem; }
        .st-completed .card { border-left: 4px solid #28a745; }
        .st-failed    .card { border-left: 4px solid #dc3545; }
        .st-processing .card { border-left: 4px solid #ffc107; }
        .st-pending   .card { border-left: 4px solid #6c757d; }
    </style>
}

<div class="container my-5">
    <div class="card shadow-sm rounded-4">
        <div class="card-header bg-transparent border-0 pt-4 pb-0">
            <h2 class="mb-0"><i class="bi bi-speedometer2 me-2"></i><span data-i18n="queue.title">Batch Status</span></h2>
        </div>
        <div class="card-body">
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-info">
                    @TempData["Message"]
                    @if (TempData["BatchId"] != null)
                    {
                        <div class="text-muted small mt-1">(batch id @TempData["BatchId"])</div>
                    }
                </div>
            }

            <!-- Overall Progress Bar -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span class="fw-semibold" id="progressLabel" data-i18n="queue.checking">Checking status…</span>
                    <span class="text-muted small" id="progressPercent"></span>
                </div>
                <div class="progress batch-progress">
                    <div id="progressBar" class="progress-bar bg-success" role="progressbar"
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>

            <div id="batchStatus" class="alert alert-light">
                <i class="bi bi-hourglass-split me-1"></i> <span data-i18n="queue.loading">Loading batch information…</span>
            </div>

            <div id="fileCards" class="mt-4">
                @* JavaScript will inject individual file cards here *@
            </div>

            <!-- Action buttons -->
            <div class="d-flex flex-wrap gap-2 mt-4">
                <div id="downloadSection" style="display: none;">
                    <a id="downloadBtn" href="#" class="btn btn-success">
                        <i class="bi bi-download me-1"></i> <span data-i18n="queue.download">Download Results (ZIP)</span>
                    </a>
                </div>
                <div id="certificateSection" style="display: none;">
                    <a id="certificateBtn" href="#" class="btn btn-outline-primary">
                        <i class="bi bi-award me-1"></i> <span data-i18n="queue.certificate">View Certificate</span>
                    </a>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left-circle me-1"></i> <span data-i18n="queue.backUpload">Back to Upload</span>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
          const runId       = "@runId";
          const statusEl    = document.getElementById("batchStatus");
          const fileCardsEl = document.getElementById("fileCards");
          const downloadSection = document.getElementById("downloadSection");
          const downloadBtn = document.getElementById("downloadBtn");
          const certificateSection = document.getElementById("certificateSection");
          const certificateBtn = document.getElementById("certificateBtn");
          const progressBar = document.getElementById("progressBar");
          const progressLabel = document.getElementById("progressLabel");
          const progressPercent = document.getElementById("progressPercent");

          function copyHash(text, btn) {
              navigator.clipboard.writeText(text).then(() => {
                  const orig = btn.innerHTML;
                  btn.innerHTML = '<i class="bi bi-check-lg"></i> ' + I18N.t('hash.copied');
                  btn.classList.replace('btn-outline-secondary', 'btn-success');
                  setTimeout(() => {
                      btn.innerHTML = orig;
                      btn.classList.replace('btn-success', 'btn-outline-secondary');
                  }, 1500);
              });
          }
          window.copyHash = copyHash;

          async function poll() {
            const res = await fetch('/FileQueue/BatchStatus?runId=' + runId);
            if (!res.ok) return;

            const job = await res.json();
            const dt  = job.startedAt ? new Date(job.startedAt) : new Date();
            const date = dt.toLocaleDateString();
            const time = dt.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});

            const total      = job.files.length;
            const completed  = job.files.filter(f => f.status === "Completed").length;
            const failed     = job.files.filter(f => f.status === "Failed").length;
            const processing = job.files.filter(f => f.status === "Processing").length;
            const done = completed + failed;
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;

            // Update progress bar
            progressBar.style.width = pct + '%';
            progressBar.setAttribute('aria-valuenow', pct);
            progressPercent.textContent = pct + '%';

            if (processing > 0) {
                progressBar.classList.remove('bg-success', 'bg-danger');
                progressBar.classList.add('bg-warning', 'progress-bar-striped', 'progress-bar-animated');
                progressLabel.innerHTML = '<i class="bi bi-gear-fill me-1 spin"></i> ' + I18N.t('queue.processing') + ' ' + done + '/' + total;
            } else if (failed > 0 && completed === 0) {
                progressBar.classList.remove('bg-warning', 'bg-success', 'progress-bar-striped', 'progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressLabel.innerHTML = '<i class="bi bi-x-circle me-1"></i> ' + I18N.t('queue.failed');
            } else {
                progressBar.classList.remove('bg-warning', 'progress-bar-striped', 'progress-bar-animated');
                progressBar.classList.add('bg-success');
                progressLabel.innerHTML = '<i class="bi bi-check-circle me-1"></i> ' + I18N.t('queue.complete');
            }

            let summary;
            if (processing > 0) {
              summary = '<i class="bi bi-hourglass-split me-1"></i> ' + I18N.t('queue.processing') + ' ' + processing + '/' + total + ' ' + I18N.t('queue.remaining');
            } else {
              summary = '<i class="bi bi-check-circle me-1"></i> ' + completed + '/' + total + ' ' + I18N.t('queue.completed');
              if (failed > 0) summary += ', <span class="text-danger">' + failed + ' ' + I18N.t('queue.failed').toLowerCase() + '</span>';
            }
            statusEl.innerHTML = date + ' ' + time + ' — ' + summary;

            fileCardsEl.innerHTML = "";

            (job.files || []).forEach(f => {
              const wrapper = document.createElement("div");
              wrapper.className = "file-card st-" + (f.status || "").toLowerCase();

              const card = document.createElement("div");
              card.className = "card";

              const body = document.createElement("div");
              body.className = "card-body";

              const title = document.createElement("h6");
              title.className = "card-title mb-1";
              const fileName = f.path.split('\\').pop().split('/').pop();
              title.innerHTML = '<i class="bi bi-file-earmark me-1"></i> ' + fileName;

              const badge = document.createElement("span");
              badge.className = "badge me-2 " +
                (f.status === "Completed" ? "bg-success"
                  : f.status === "Failed" ? "bg-danger"
                    : f.status === "Processing" ? "bg-warning text-dark"
                    : "bg-secondary");
              badge.textContent = f.status;

              let retry = null;
              if (f.retries > 0) {
                retry = document.createElement("span");
                retry.className = "badge bg-secondary me-2";
                retry.textContent = I18N.t('queue.retries') + ": " + f.retries;
              }

              const times = document.createElement("p");
              times.className = "card-text small text-muted mb-0";
              const started = f.startedAt
                ? I18N.t('queue.started') + ': ' + new Date(f.startedAt).toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"})
                : "";
              const finished = f.finishedAt
                ? ' | ' + I18N.t('queue.finished') + ': ' + new Date(f.finishedAt).toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"})
                : "";
              times.textContent = started + finished;

              body.appendChild(title);
              body.appendChild(badge);
              if (retry) body.appendChild(retry);
              body.appendChild(times);

              card.appendChild(body);
              wrapper.appendChild(card);
              fileCardsEl.appendChild(wrapper);
            });

            // Show download & certificate when done
            if (job.status === "Completed" || job.status === "Failed") {
              if (completed > 0) {
                downloadSection.style.display = "block";
                downloadBtn.href = '/FileQueue/Download?runId=' + runId;
                certificateSection.style.display = "block";
                certificateBtn.href = '/FileQueue/Certificate?runId=' + runId;
              }
            } else {
              setTimeout(poll, 600);
            }
          }

          poll();
        })();
    </script>
}
