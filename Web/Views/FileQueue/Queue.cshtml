@{
    Layout = "_Layout";
    var runId = ViewBag.RunId as string;
    var displayName = ViewBag.DisplayName as string ?? "Your";
}

@section Styles {
    <style>
        /* File card spacing */
        .file-card {
            margin-bottom: 1rem;
        }
        /* Status border colors */
        .st-completed .card {
            border-left: 4px solid #28a745;
        }

        .st-failed .card {
            border-left: 4px solid #dc3545;
        }

        .st-processing .card {
            border-left: 4px solid #ffc107;
        }
    </style>
}

<div class="container my-5">
    <div class="card">
        <div class="card-header bg-white">
            <h2 class="mb-0">@displayName’s Batch Status</h2>
        </div>
        <div class="card-body">
            @if (TempData["Message"] != null)
            {
            <div class="alert alert-info">
                @TempData["Message"]
                @if (TempData["BatchId"] != null)
                    {
                <div class="text-muted small mt-1">
                    (batch id @TempData["BatchId"])
                </div>
                    }
            </div>
            }

            <div id="batchStatus" class="alert alert-light">
                Checking status…
            </div>

            <div id="fileCards" class="mt-4">
                @* JavaScript will inject individual file cards here *@
            </div>

            <div id="downloadSection" class="mt-4" style="display: none;">
                <a id="downloadBtn" href="#" class="btn btn-success me-2">
                    <i class="bi bi-download me-1"></i> Download Results (ZIP)
                </a>
                <small class="text-muted">Output files are automatically deleted after the configured retention period.</small>
            </div>

            <a asp-action="Index" class="btn btn-outline-secondary mt-4">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to Upload
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
          const runId       = "@runId";
          const statusEl    = document.getElementById("batchStatus");
          const fileCardsEl = document.getElementById("fileCards");
          const downloadSection = document.getElementById("downloadSection");
          const downloadBtn = document.getElementById("downloadBtn");

          async function poll() {
            const res = await fetch(`/FileQueue/BatchStatus?runId=${runId}`);
            if (!res.ok) return;

            const job = await res.json();
            const dt  = job.startedAt
                         ? new Date(job.startedAt)
                         : new Date();
            const date = dt.toLocaleDateString("tr-TR");
            const time = dt.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});

            const total      = job.files.length;
            const completed  = job.files.filter(f => f.status === "Completed").length;
            const failed     = job.files.filter(f => f.status === "Failed").length;
            const processing = job.files.filter(f => f.status === "Processing").length;

            let summary;
            if (processing > 0) {
              summary = `Processing… ${processing} / ${total}`;
            } else {
              summary = `${completed} / ${total} completed`;
              if (failed > 0) summary += `, ${failed} failed`;
            }
            statusEl.textContent = `${date} ${time} → ${summary}`;

            // clear existing cards
            fileCardsEl.innerHTML = "";

            // build a card for each file
            (job.files || []).forEach(f => {
              // outer wrapper to get the status class for border-color
              const wrapper = document.createElement("div");
              wrapper.className = "file-card st-" + (f.status || "").toLowerCase();

              // create the card
              const card = document.createElement("div");
              card.className = "card";

              const body = document.createElement("div");
              body.className = "card-body";

              // title = filename
              const title = document.createElement("h5");
              title.className = "card-title mb-1";
              title.textContent = f.path.split('\\').pop();

              // status badge
              const badge = document.createElement("span");
              badge.className = "badge me-2 " +
                (f.status === "Completed"
                  ? "bg-success"
                  : f.status === "Failed"
                    ? "bg-danger"
                    : "bg-warning text-dark");
              badge.textContent = f.status;

              // retry badge (only if retries > 0)
              let retry = null;
              if (f.retries > 0) {
                retry = document.createElement("span");
                retry.className = "badge bg-secondary me-2";
                retry.textContent = "retries: " + f.retries;
              }

              // timestamps
              const times = document.createElement("p");
              times.className = "card-text small text-muted mb-0";
              const started = f.startedAt
                ? `Started: ${new Date(f.startedAt).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"})}`
                : "";
              const finished = f.finishedAt
                ? ` | Finished: ${new Date(f.finishedAt).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"})}`
                : "";
              times.textContent = started + finished;

              // assemble
              body.appendChild(title);
              body.appendChild(badge);
              if (retry) body.appendChild(retry);
              body.appendChild(times);

              card.appendChild(body);
              wrapper.appendChild(card);
              fileCardsEl.appendChild(wrapper);
            });

            // Show download button when batch is done and has completed files
            if (job.status === "Completed" || job.status === "Failed") {
              if (completed > 0) {
                downloadSection.style.display = "block";
                downloadBtn.href = `/FileQueue/Download?runId=${runId}`;
              }
            } else {
              setTimeout(poll, 600);
            }
          }

          poll();
        })();
    </script>
}
