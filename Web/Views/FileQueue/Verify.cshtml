@{
    ViewData["Title"] = "Verify File Integrity";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <i class="bi bi-patch-check-fill display-4 text-success"></i>
                <h2 class="mt-2">Verify File Integrity</h2>
                <p class="text-muted">
                    Upload a file and provide a known hash to check if the file has been tampered with.
                    <br /><strong>Your file never leaves your browser</strong> â€” hashing is done locally.
                </p>
            </div>

            <div class="card shadow-sm rounded-4">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">File to Verify</label>
                        <div class="drop-zone" id="verifyDropZone">
                            <div class="drop-icon"><i class="bi bi-file-earmark-check"></i></div>
                            <p class="mb-1 fw-semibold">Drag &amp; drop file here</p>
                            <p class="text-muted small mb-0">or click to browse</p>
                            <input type="file" class="d-none" id="verifyFileInput" />
                            <div id="verifyFileName" class="mt-2" style="display:none;"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Hash Algorithm</label>
                        <select class="form-select" id="verifyAlgorithm">
                            <option value="SHA256" selected>SHA-256</option>
                            <option value="SHA512">SHA-512</option>
                            <option value="MD5">MD5</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Expected Hash</label>
                        <textarea class="form-control font-monospace" id="expectedHash" rows="3"
                                  placeholder="Paste the expected hash value here..." style="font-size: 0.85rem;"></textarea>
                    </div>

                    <button type="button" class="btn btn-success w-100 btn-lg" id="verifyBtn">
                        <i class="bi bi-check-circle me-1"></i> Verify
                    </button>

                    <div id="verifyError" class="alert alert-warning mt-3" style="display:none;"></div>
                    <div id="verifySpinner" class="text-center mt-3" style="display:none;">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-2 text-muted">Hashing file locally...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4" id="verifyResult"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    (function() {
        var dropZone = document.getElementById('verifyDropZone');
        var fileInput = document.getElementById('verifyFileInput');
        var fileNameEl = document.getElementById('verifyFileName');
        var verifyBtn = document.getElementById('verifyBtn');
        var errorEl = document.getElementById('verifyError');
        var spinnerEl = document.getElementById('verifySpinner');
        var resultEl = document.getElementById('verifyResult');
        var selectedFile = null;

        // Drop zone
        dropZone.addEventListener('click', function() { fileInput.click(); });
        ['dragenter','dragover'].forEach(function(evt) {
            dropZone.addEventListener(evt, function(e) { e.preventDefault(); dropZone.classList.add('drag-over'); });
        });
        ['dragleave','drop'].forEach(function(evt) {
            dropZone.addEventListener(evt, function(e) { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        });
        dropZone.addEventListener('drop', function(e) {
            selectedFile = e.dataTransfer.files[0];
            showFile(selectedFile);
        });
        fileInput.addEventListener('change', function() {
            selectedFile = fileInput.files[0];
            showFile(selectedFile);
        });

        function showFile(f) {
            if (f) {
                fileNameEl.style.display = 'block';
                fileNameEl.textContent = f.name + ' (' + formatBytes(f.size) + ')';
                fileNameEl.className = 'mt-2 badge bg-primary';
            }
        }

        function formatBytes(b) {
            if (b < 1024) return b + ' B';
            if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
            return (b/(1024*1024)).toFixed(1) + ' MB';
        }

        function hashFile(buffer, algo) {
            var wordArray = CryptoJS.lib.WordArray.create(new Uint8Array(buffer));
            switch (algo) {
                case 'SHA512': return CryptoJS.SHA512(wordArray).toString();
                case 'MD5':    return CryptoJS.MD5(wordArray).toString();
                default:       return CryptoJS.SHA256(wordArray).toString();
            }
        }

        verifyBtn.addEventListener('click', function() {
            errorEl.style.display = 'none';
            resultEl.innerHTML = '';

            if (!selectedFile) {
                errorEl.textContent = 'Please select a file.';
                errorEl.style.display = 'block';
                return;
            }
            var expected = document.getElementById('expectedHash').value.trim().toLowerCase().replace(/\s/g, '');
            if (!expected) {
                errorEl.textContent = 'Please enter a hash value.';
                errorEl.style.display = 'block';
                return;
            }

            var algo = document.getElementById('verifyAlgorithm').value;
            spinnerEl.style.display = 'block';
            verifyBtn.disabled = true;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var actual = hashFile(e.target.result, algo);
                    var isMatch = actual === expected;

                    spinnerEl.style.display = 'none';
                    verifyBtn.disabled = false;

                    var div = document.createElement('div');
                    div.className = 'verify-result ' + (isMatch ? 'verify-match' : 'verify-mismatch');

                    var icon = document.createElement('i');
                    icon.className = isMatch ? 'bi bi-check-circle-fill text-success' : 'bi bi-x-circle-fill text-danger';
                    icon.style.fontSize = '3rem';
                    div.appendChild(icon);

                    var title = document.createElement('h3');
                    title.className = 'mt-2';
                    title.textContent = isMatch ? 'Match! File is authentic.' : 'Mismatch! File may be tampered.';
                    div.appendChild(title);

                    var info = document.createElement('div');
                    info.className = 'mb-2';
                    info.innerHTML = '<strong>File:</strong> ' + selectedFile.name +
                        ' (' + formatBytes(selectedFile.size) + ')' +
                        '<br/><strong>Algorithm:</strong> ' + algo;
                    div.appendChild(info);

                    var hr = document.createElement('hr');
                    div.appendChild(hr);

                    var details = document.createElement('div');
                    details.className = 'text-start';

                    var expLabel = document.createElement('p');
                    expLabel.className = 'mb-1';
                    expLabel.innerHTML = '<strong>Expected:</strong>';
                    details.appendChild(expLabel);
                    var expHash = document.createElement('div');
                    expHash.className = 'hash-display bg-body-secondary';
                    expHash.textContent = expected;
                    details.appendChild(expHash);

                    var actLabel = document.createElement('p');
                    actLabel.className = 'mb-1 mt-2';
                    actLabel.innerHTML = '<strong>Actual:</strong>';
                    details.appendChild(actLabel);
                    var actHash = document.createElement('div');
                    actHash.className = 'hash-display bg-body-secondary';
                    actHash.textContent = actual;
                    details.appendChild(actHash);

                    div.appendChild(details);
                    resultEl.appendChild(div);
                } catch(ex) {
                    spinnerEl.style.display = 'none';
                    verifyBtn.disabled = false;
                    errorEl.textContent = 'Error hashing file: ' + ex.message;
                    errorEl.style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        });
    })();
    </script>
}
