version: '3.8'

# Production Docker Compose for Linux Server Deployment
# Using SSD storage (/opt/stack/) for all application data
# - Config: /opt/stack/config/secure-sequentier/
# - Data: /opt/stack/data/secure-sequentier/

services:
  backend:
    build:
      context: .
      dockerfile: SecureSolution2/Dockerfile
    container_name: secure-sequentier-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:9999:9999"  # Only bind to localhost for Cloudflare Tunnel
    volumes:
      - /opt/stack/data/secure-sequentier/watch:/app/data/watch
      - /opt/stack/data/secure-sequentier/queue:/app/data/queue
      - /opt/stack/data/secure-sequentier/processed:/app/data/processed
      - /opt/stack/data/secure-sequentier/logs:/app/data/logs
      - /opt/stack/config/secure-sequentier/DefaultConfig.json:/app/DefaultConfig.json:ro
      - /opt/stack/data/secure-sequentier/subsystems:/app/subsystems:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:9999
    networks:
      - secure-sequentier-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: .
      dockerfile: Web/Dockerfile
    container_name: secure-sequentier-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:5188:5188"  # Only bind to localhost for Cloudflare Tunnel
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - /opt/stack/data/secure-sequentier/queue:/app/data/queue:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5188
      - BACKEND_API_URL=http://backend:9999
    networks:
      - secure-sequentier-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5188 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  secure-sequentier-network:
    driver: bridge

